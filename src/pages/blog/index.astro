---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import PageHeader from '../../components/PageHeader.astro';
import BlogCard from '../../components/BlogCard.astro';
import BlogFilter from '../../components/BlogFilter.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import { generateBlogBreadcrumbs } from '../../utils/breadcrumbs.ts';
import type { BlogPost } from '../../types/index.ts';

// Get URL parameters for filtering
const url = new URL(Astro.request.url);
const selectedTag = url.searchParams.get('tag');
const showFeaturedOnly = url.searchParams.get('featured') === 'true';

// Get all blog posts and sort by date (newest first)
const allBlogPosts = await getCollection('blog');
let publishedPosts = allBlogPosts
  .filter(post => !post.data.draft)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Apply tag filter if selected
if (selectedTag) {
  publishedPosts = publishedPosts.filter(post => 
    post.data.tags.some(tag => tag.toLowerCase() === selectedTag.toLowerCase())
  );
}

// Apply featured filter if selected
if (showFeaturedOnly) {
  publishedPosts = publishedPosts.filter(post => post.data.featured);
}

const featuredPosts = publishedPosts.filter(post => post.data.featured);
const totalPostCount = allBlogPosts.filter(post => !post.data.draft).length;
const filteredCount = publishedPosts.length;

// Dynamic title and description based on filters
let pageTitle = 'Blog';
let pageDescription = 'Thoughts on technology, cybersecurity, emergency management, and ham radio.';

if (selectedTag && showFeaturedOnly) {
  pageTitle = `Featured Posts about ${selectedTag}`;
  pageDescription = `Featured blog posts about ${selectedTag} from Austin Cole.`;
} else if (selectedTag) {
  pageTitle = `Posts about ${selectedTag}`;
  pageDescription = `Blog posts about ${selectedTag} from Austin Cole.`;
} else if (showFeaturedOnly) {
  pageTitle = 'Featured Posts';
  pageDescription = 'Featured blog posts from Austin Cole.';
}

// Generate breadcrumbs
const breadcrumbs = generateBlogBreadcrumbs(selectedTag, showFeaturedOnly);
---

<Layout title={pageTitle} description={pageDescription}>
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <!-- Breadcrumb Navigation -->
    <Breadcrumb items={breadcrumbs} className="mb-6" />
    
    <PageHeader 
      title={pageTitle} 
      subtitle={filteredCount < totalPostCount ? `${filteredCount} of ${totalPostCount} posts` : undefined}
      description={pageDescription}
    />

    <!-- Blog Filters -->
    <BlogFilter selectedTag={selectedTag} showFeaturedOnly={showFeaturedOnly} />

    <!-- Featured Posts (only show if not filtering and we have featured posts) -->
    {featuredPosts.length > 0 && !selectedTag && !showFeaturedOnly && (
      <section class="mb-16" aria-labelledby="featured-posts-heading">
        <h2 id="featured-posts-heading" class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-8">Featured Posts</h2>
        <div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
          {featuredPosts.map((post) => (
            <BlogCard post={post} variant="featured" />
          ))}
        </div>
      </section>
    )}

    <!-- Posts Results -->
    <section aria-labelledby="posts-results-heading">
      <h2 id="posts-results-heading" class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-8">
        {selectedTag || showFeaturedOnly ? 'Results' : (featuredPosts.length > 0 ? 'All Posts' : 'Recent Posts')}
      </h2>
      
      {publishedPosts.length > 0 ? (
        <div class="space-y-8">
          {publishedPosts.map((post) => (
            <BlogCard post={post} variant="default" />
          ))}
        </div>
      ) : (
        <div class="text-center py-12">
          <div class="max-w-md mx-auto">
            <p class="text-gray-600 dark:text-gray-300 text-lg mb-4">
              {selectedTag || showFeaturedOnly 
                ? 'No posts match your current filters.'
                : 'No blog posts available yet. Check back soon!'
              }
            </p>
            {(selectedTag || showFeaturedOnly) && (
              <a 
                href="/blog/" 
                class="btn btn-primary"
              >
                View All Posts
              </a>
            )}
          </div>
        </div>
      )}
    </section>
  </div>
</Layout>
